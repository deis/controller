#!/usr/bin/env bash
#
# This script is designed to be run inside the container
#

# fail hard and fast even on pipelines
set -eo pipefail

# set debug based on envvar
[[ $DEBUG ]] && set -x

# allow deis user permission to Docker if the socket is present
if [ -f /var/run/docker.sock ]; then
    if addgroup -g "$(stat -c "%g" /var/run/docker.sock)" docker; then
        addgroup deis docker
    fi
fi

# run an idempotent database migration
sudo -E -u deis ./manage.py syncdb --migrate --noinput

./manage.py load_db_state_to_etcd

# run the controller
exec sudo -E -u deis gunicorn -c deis/gconf.py deis.wsgi &
